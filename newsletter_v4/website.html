<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Pulse - Construction & Real Estate Intelligence v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #ffffff;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --popover: #ffffff;
            --popover-foreground: #0f172a;
            --primary: #0f172a;
            --primary-foreground: #f8fafc;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #0f172a;
            --radius: 0.5rem;
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --foreground: #f8fafc;
            --card: #1e293b;
            --card-foreground: #f8fafc;
            --popover: #1e293b;
            --popover-foreground: #f8fafc;
            --primary: #f8fafc;
            --primary-foreground: #0f172a;
            --secondary: #334155;
            --secondary-foreground: #f8fafc;
            --muted: #334155;
            --muted-foreground: #94a3b8;
            --accent: #334155;
            --accent-foreground: #f8fafc;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #334155;
            --input: #334155;
            --ring: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            height: 80px;
        }

        .logo:hover {
            opacity: 0.8;
        }

        .logo-image {
            height: 80px;
            width: auto;
        }

        .nav {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav a {
            text-decoration: none;
            color: var(--muted-foreground);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav a:hover,
        .nav a.active {
            color: var(--foreground);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem;
            cursor: pointer;
            color: var(--foreground);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--accent);
        }

        /* Main Content */
        .main {
            padding: 2rem 0;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--muted-foreground);
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }

        /* Theme Grid */

        .theme-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--ring);
        }

        .theme-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6);
        }

        .theme-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .theme-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .theme-icon.opportunities { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .theme-icon.practices { background: linear-gradient(135deg, #10b981, #059669); }
        .theme-icon.vision { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .theme-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .theme-description {
            color: var(--muted-foreground);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .theme-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .article-count {
            background: var(--secondary);
            color: var(--secondary-foreground);
            padding: 0.25rem 0.75rem;
            border-radius: calc(var(--radius) / 2);
            font-size: 0.875rem;
            font-weight: 500;
        }


        /* Articles Grid */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Homepage Articles Grid - Single Column */
        .articles-grid.homepage {
            grid-template-columns: 1fr;
            gap: 2rem;
            max-width: 800px;
            margin: 2rem auto 0;
        }

        /* Article Card */
        .article-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--ring);
        }

        /* Image Container */
        .article-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            overflow: hidden;
            background: var(--muted);
        }

        .article-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .article-card:hover .article-image {
            transform: scale(1.05);
        }

        /* Source Badge */
        .source-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: calc(var(--radius) / 2);
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* Article Content */
        .article-content {
            padding: 1.5rem;
        }

        .article-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.75rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }


        /* Takeaways */
        .takeaways {
            margin-bottom: 1rem;
        }

        .takeaway-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }


        /* Why It Matters */
        .why-it-matters {
            background: var(--secondary) !important;
            border-left: 4px solid var(--primary) !important;
            padding: 1rem !important;
            border-radius: 0 var(--radius) var(--radius) 0 !important;
            margin-bottom: 1rem !important;
            display: block !important;
        }

        .why-it-matters-title {
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .why-it-matters-text {
            font-size: 0.875rem;
            color: var(--muted-foreground);
            line-height: 1.5;
        }

        /* Article Footer */
        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .article-date {
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }


        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--muted-foreground);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                gap: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .articles-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

        }

        /* Hidden class for dynamic content */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo" onclick="showHome()">
                    <img src="/logo.png" alt="BUILT BY MARK SCOTT" class="logo-image">
                </a>
                <nav class="nav">
                    <a href="#" class="nav-link" onclick="showTheme('opportunities')">Opportunities</a>
                    <a href="#" class="nav-link" onclick="showTheme('practices')">Practices</a>
                    <a href="#" class="nav-link" onclick="showTheme('vision')">Vision</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
    <div class="container">
        <!-- Home Page -->
        <div id="home-page">
                <h1 class="page-title">Construction & Real Estate Intelligence</h1>
                <p class="page-subtitle">Discover insights, opportunities, and innovations shaping the built environment</p>
                
                <div id="home-articles-grid" class="articles-grid homepage">
                    <!-- Top 7 articles will be populated by JavaScript -->
                </div>
        </div>

        <!-- Theme Pages -->
        <div id="theme-page" class="hidden">
                <div id="theme-header">
                    <h1 id="theme-title" class="page-title"></h1>
                    <p id="theme-subtitle" class="page-subtitle"></p>
                        </div>
                
                <div id="articles-grid" class="articles-grid">
                    <!-- Articles will be populated by JavaScript -->
                    </div>
                </div>

            <!-- Loading State -->
            <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                Loading articles...
                </div>
                </div>
    </main>

    <script>
        const API_BASE = 'https://newsletter-api-v2.onrender.com';
        
        const THEMES = {
            opportunities: {
                name: 'Development & Deals',
                description: 'Where the money and momentum are. People and projects building wealth through development, investment, and smart risk-taking.',
                icon: 'ðŸ’°',
                color: '#3b82f6'
            },
            practices: {
                name: 'Building Better',
                description: 'How the next generation builds. The craft and science of modern construction and design.',
                icon: 'ðŸ”§',
                color: '#10b981'
            },
            vision: {
                name: 'Forces & Frameworks',
                description: 'Why markets move, and how to position yourself before they do. Demand drivers, migration patterns, policy changes, and regional growth strategies.',
                icon: 'ðŸ“Š',
                color: '#8b5cf6'
            }
        };

        let currentTheme = 'home';

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            body.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
        }

        // Navigation
        function updateNavigation(activeLink) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Enhanced image extraction utility
        function extractImageFromContent(content) {
            if (!content) return null;
            
            // Create a temporary DOM element to parse HTML properly
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Try to find img tags with better parsing
            const images = tempDiv.querySelectorAll('img');
            
            for (let img of images) {
                let imageUrl = img.src || img.getAttribute('src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
                
                // Try data-src (lazy loading)
                imageUrl = img.getAttribute('data-src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
                
                // Try data-lazy-src
                imageUrl = img.getAttribute('data-lazy-src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
            }
            
            // Also try regex extraction as fallback for malformed HTML
            const imgRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
            let imgMatch = imgRegex.exec(content);
            if (imgMatch) {
                let imageUrl = imgMatch[1];
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
            }
            
            // Try to find srcset
            const srcsetImgs = tempDiv.querySelectorAll('img[srcset]');
            for (let img of srcsetImgs) {
                const srcset = img.getAttribute('srcset');
                if (srcset) {
                    const urls = srcset.split(',').map(src => src.trim().split(' ')[0]);
                    for (const url of urls) {
                        if (isValidImageUrl(url)) {
                            const cleanUrl = cleanImageUrl(url);
                            if (cleanUrl) return cleanUrl;
                        }
                    }
                }
            }
            
            // Try to find Open Graph meta tags in content
            const ogImageRegex = /<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/gi;
            let ogMatch = ogImageRegex.exec(content);
            if (ogMatch) {
                const imageUrl = ogMatch[1];
                if (isValidImageUrl(imageUrl)) {
                    return cleanImageUrl(imageUrl);
                }
            }
            
            // Try to find Twitter card meta tags
            const twitterImageRegex = /<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["']/gi;
            let twitterMatch = twitterImageRegex.exec(content);
            if (twitterMatch) {
                const imageUrl = twitterMatch[1];
                if (isValidImageUrl(imageUrl)) {
                    return cleanImageUrl(imageUrl);
                }
            }
            
            return null;
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            
            // Must be a valid image extension
            const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)$/i;
            if (!imageExtensions.test(url)) return false;
            
            // Exclude common non-content images
            const excludePatterns = /logo|icon|avatar|placeholder|spacer|pixel|banner|advert|ad|social|share|button|nav|header|footer|widget/i;
            if (excludePatterns.test(url)) return false;
            
            // Exclude very small images (likely icons)
            if (url.includes('16x16') || url.includes('32x32') || url.includes('24x24')) return false;
            
            // Must be a proper URL
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        function cleanImageUrl(url) {
            if (url.startsWith('//')) {
                return 'https:' + url;
            }
            if (url.startsWith('/')) {
                return window.location.origin + url;
            }
            return url;
        }

        function getFallbackImage(articleId, theme = 'general') {
            const themeImages = {
                opportunities: [
                    'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Business building
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // City skyline
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Construction
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Architecture
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Real estate
                ],
                practices: [
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Construction site
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Building construction
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Modern building
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Architecture
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Urban development
                ],
                vision: [
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Smart city
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Future buildings
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Sustainable design
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Innovation
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Technology
                ],
                general: [
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'
                ]
            };
            
            const images = themeImages[theme] || themeImages.general;
            return images[articleId % images.length];
        }

        // Robust image error handling with proxy fallback
        function handleImageError(imgElement, proxyUrl, fallbackUrl) {
            if (!imgElement.dataset.triedProxy) {
                // Try proxy first
                imgElement.dataset.triedProxy = 'true';
                imgElement.src = proxyUrl;
                console.log('Image failed, trying proxy:', proxyUrl);
            } else if (!imgElement.dataset.triedFallback) {
                // Try fallback
                imgElement.dataset.triedFallback = 'true';
                imgElement.src = fallbackUrl;
                console.log('Proxy failed, using fallback:', fallbackUrl);
            } else {
                // All options exhausted
                console.log('All image options failed for:', imgElement.alt);
            }
        }

        // Generate 3 condensed bullet points summarizing the article
        function generateTakeaways(content, title) {
            const text = content ? content.replace(/<[^>]*>/g, '') : '';
            
            // Simple AI-like summarization by extracting key sentences
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 20);
            
            // Look for sentences with key indicators
            const keyIndicators = [
                'roi', 'return', 'profit', 'revenue', 'cost', 'savings', 'investment',
                'development', 'construction', 'building', 'project', 'market',
                'innovation', 'technology', 'efficiency', 'productivity', 'growth',
                'first', 'only', 'unprecedented', 'breakthrough', 'new', 'improved'
            ];
            
            const scoredSentences = sentences.map(sentence => {
                const lowerSentence = sentence.toLowerCase();
                let score = 0;
                keyIndicators.forEach(indicator => {
                    if (lowerSentence.includes(indicator)) score += 1;
                });
                // Bonus for numbers and specific data
                if (/\$|\d+%|\d+(?:\.\d+)?\s*(?:million|billion|thousand)/i.test(sentence)) score += 2;
                return { sentence: sentence.trim(), score };
            });
            
            // Get top 3 sentences
            const topSentences = scoredSentences
                .filter(s => s.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3)
                .map(s => s.sentence);
            
            // If we don't have enough scored sentences, fill with general ones
            while (topSentences.length < 3) {
                const remainingSentences = sentences.filter(s => !topSentences.includes(s.trim()));
                if (remainingSentences.length > 0) {
                    topSentences.push(remainingSentences[topSentences.length].trim());
                } else {
                    break;
                }
            }
            
            // Format as bullet points
            return topSentences.slice(0, 3).map(sentence => {
                // Clean up the sentence
                let cleaned = sentence.trim();
                if (cleaned.length > 80) {
                    cleaned = cleaned.substring(0, 77) + '...';
                }
                return `âœ… ${cleaned}`;
            });
        }

        // Generate unique "why it matters" text for each article
        function generateWhyItMatters(content, title, theme) {
            const text = content ? content.replace(/<[^>]*>/g, '') : '';
            const lowerText = text.toLowerCase();
            const lowerTitle = title.toLowerCase();
            const combinedText = lowerTitle + ' ' + lowerText;
            
            // Extract specific details to make each response unique
            const extractNumbers = (str) => {
                const matches = str.match(/\d+(?:\.\d+)?(?:%|\$|million|billion|thousand)?/gi);
                return matches ? matches.slice(0, 3) : [];
            };

            const extractLocations = (str) => {
                const locationPatterns = [
                    /\b(?:New York|Los Angeles|Chicago|Houston|Phoenix|Philadelphia|San Antonio|San Diego|Dallas|San Jose|Austin|Jacksonville|Fort Worth|Columbus|Charlotte|San Francisco|Indianapolis|Seattle|Denver|Washington|Boston|El Paso|Nashville|Detroit|Oklahoma City|Portland|Las Vegas|Memphis|Louisville|Baltimore|Milwaukee|Albuquerque|Tucson|Fresno|Sacramento|Mesa|Kansas City|Atlanta|Long Beach|Colorado Springs|Raleigh|Miami|Virginia Beach|Omaha|Oakland|Minneapolis|Tulsa|Arlington|Tampa|New Orleans|Wichita|Cleveland|Bakersfield|Aurora|Anaheim|Honolulu|Santa Ana|Corpus Christi|Riverside|Lexington|Stockton|Henderson|Saint Paul|St\. Louis)\b/g,
                    /\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\s+(?:City|County|State|Province|District)\b/g,
                    /\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\b(?=\s+(?:project|development|building|construction|facility|center|park|district|neighborhood|area|region))\b/g
                ];
                
                let locations = [];
                locationPatterns.forEach(pattern => {
                    const matches = str.match(pattern);
                    if (matches) locations = locations.concat(matches);
                });
                return [...new Set(locations)].slice(0, 3);
            };
            
            const extractCompanies = (str) => {
                const companyPatterns = [
                    /\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s+(?:Inc|Corp|LLC|Ltd|Company|Group|Partners|Associates|Development|Construction|Building|Realty|Properties|Capital|Investments|Holdings|Management))\b/g,
                    /\b[A-Z]{2,}(?:\s+[A-Z]{2,})*\b/g // Acronyms like CBRE, JLL, etc.
                ];
                
                let companies = [];
                companyPatterns.forEach(pattern => {
                    const matches = str.match(pattern);
                    if (matches) companies = companies.concat(matches);
                });
                return [...new Set(companies)].slice(0, 2);
            };
            
            const extractKeyPhrases = (str) => {
                // Extract important phrases that could become bullet points
                const phrases = [];
                
                // Look for "key" or "important" phrases
                const keyMatches = str.match(/(?:key|important|significant|major|critical|notable|prominent)\s+[^.!?]{10,60}/gi);
                if (keyMatches) phrases.push(...keyMatches.slice(0, 2));
                
                // Look for benefits or outcomes
                const benefitMatches = str.match(/(?:enables|allows|provides|offers|delivers|creates|generates|reduces|increases|improves|enhances)\s+[^.!?]{10,60}/gi);
                if (benefitMatches) phrases.push(...benefitMatches.slice(0, 2));
                
                // Look for results or achievements
                const resultMatches = str.match(/(?:achieves|accomplishes|results in|leads to|contributes to|drives)\s+[^.!?]{10,60}/gi);
                if (resultMatches) phrases.push(...resultMatches.slice(0, 2));
                
                return phrases.slice(0, 3);
            };
            
            const numbers = extractNumbers(combinedText);
            const locations = extractLocations(combinedText);
            const companies = extractCompanies(combinedText);
            const keyPhrases = extractKeyPhrases(combinedText);
            
            // Generate unique bullet points based on article content
            const takeaways = [];
            
            // First bullet: Extract specific data points and metrics
            const extractSpecificData = (str) => {
                const dataPoints = [];
                
                // Look for specific cost/savings data
                const costMatches = str.match(/\$[\d,]+(?:\.\d+)?(?:k|m|b|thousand|million|billion)?/gi);
                if (costMatches) dataPoints.push(...costMatches);
                
                // Look for percentage improvements
                const percentMatches = str.match(/\d+(?:\.\d+)?%/g);
                if (percentMatches) dataPoints.push(...percentMatches);
                
                // Look for time/speed improvements
                const timeMatches = str.match(/\d+(?:\.\d+)?\s*(?:days?|weeks?|months?|years?)\s*(?:faster|quicker|sooner|earlier)/gi);
                if (timeMatches) dataPoints.push(...timeMatches);
                
                // Look for specific quantities/numbers
                const quantityMatches = str.match(/\d+(?:,\d{3})*(?:\.\d+)?\s*(?:units?|buildings?|homes?|apartments?|sq ft|square feet)/gi);
                if (quantityMatches) dataPoints.push(...quantityMatches);
                
                return dataPoints.slice(0, 3);
            };
            
            const specificData = extractSpecificData(combinedText);
            
            if (specificData.length > 0) {
                const dataPoint = specificData[0];
                takeaways.push(`âœ… ${dataPoint} - concrete metric from this project`);
            } else {
                // Look for specific achievements mentioned
                const achievementMatches = combinedText.match(/(?:achieved|delivered|reduced|increased|improved|saved|generated|earned|built|completed)\s+[^.!?]{10,80}/gi);
                if (achievementMatches && achievementMatches.length > 0) {
                    const achievement = achievementMatches[0].trim();
                    takeaways.push(`âœ… ${achievement}`);
                } else {
                    takeaways.push('âœ… Specific performance data not quantified in article');
                }
            }
            
            // Second bullet: Extract interesting facts and unique details
            const extractInterestingFacts = (str) => {
                const facts = [];
                
                // Look for unique or surprising statements
                const uniqueMatches = str.match(/(?:first|only|never|unprecedented|breakthrough|revolutionary|innovative|unique|novel|groundbreaking|pioneering)\s+[^.!?]{15,100}/gi);
                if (uniqueMatches) facts.push(...uniqueMatches);
                
                // Look for comparisons or contrasts
                const comparisonMatches = str.match(/(?:compared to|versus|vs|unlike|different from|instead of|rather than)\s+[^.!?]{10,80}/gi);
                if (comparisonMatches) facts.push(...comparisonMatches);
                
                // Look for specific company/people mentions
                const entityMatches = str.match(/(?:company|firm|developer|investor|architect|contractor)\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*/g);
                if (entityMatches) facts.push(...entityMatches);
                
                return facts.slice(0, 2);
            };
            
            const interestingFacts = extractInterestingFacts(combinedText);
            
            if (interestingFacts.length > 0) {
                const fact = interestingFacts[0].trim();
                takeaways.push(`âœ… ${fact} - noteworthy detail from the article`);
            } else if (locations.length > 0) {
                const location = locations[0];
                takeaways.push(`âœ… ${location} - specific location where this is happening`);
            } else if (companies.length > 0) {
                const company = companies[0];
                takeaways.push(`âœ… ${company} - key organization involved`);
            } else {
                takeaways.push('âœ… Additional specific details not clearly quantified');
            }
            
            // Third bullet: Extract specific methodologies, processes, or techniques
            const extractMethodologies = (str) => {
                const methods = [];
                
                // Look for specific techniques or approaches
                const techniqueMatches = str.match(/(?:using|through|via|by means of|employing|implementing|applying)\s+[^.!?]{10,80}/gi);
                if (techniqueMatches) methods.push(...techniqueMatches);
                
                // Look for specific processes or steps
                const processMatches = str.match(/(?:process|method|approach|technique|strategy|system|framework|model)\s+[^.!?]{10,80}/gi);
                if (processMatches) methods.push(...processMatches);
                
                // Look for specific technologies or tools
                const techMatches = str.match(/(?:technology|software|tool|platform|system|device|equipment|material)\s+[^.!?]{10,60}/gi);
                if (techMatches) methods.push(...techMatches);
                
                // Look for specific results or outcomes
                const resultMatches = str.match(/(?:resulted in|led to|achieved|delivered|produced|generated|created)\s+[^.!?]{10,80}/gi);
                if (resultMatches) methods.push(...resultMatches);
                
                return methods.slice(0, 2);
            };
            
            const methodologies = extractMethodologies(combinedText);
            
            if (methodologies.length > 0) {
                const method = methodologies[0].trim();
                const cleanedMethod = method.length > 70 ? method.substring(0, 70) + '...' : method;
                takeaways.push(`âœ… ${cleanedMethod} - specific approach used`);
            } else if (keyPhrases.length > 0) {
                const phrase = keyPhrases[0].trim();
                const cleanedPhrase = phrase.length > 60 ? phrase.substring(0, 60) + '...' : phrase;
                takeaways.push(`âœ… ${cleanedPhrase} - key insight from article`);
            } else {
                takeaways.push('âœ… Specific methodology details require deeper analysis');
            }
            
            // Ensure we have exactly 3 takeaways
            while (takeaways.length < 3) {
                takeaways.push('âœ… Provides strategic advantage for forward-thinking organizations');
            }
            
            return takeaways.slice(0, 3);
        }


        // Create article card
        function createArticleCard(article, theme) {
            try {
                console.log(`Creating article card for: ${article.title}`);
                const card = document.createElement('div');
                card.className = 'article-card';
                
                // Enhanced image extraction with proxy system
                const OG_FN = `${API_BASE}/api/v4/proxy/image`;
                const proxyImage = (url) => `${OG_FN}?image=${encodeURIComponent(url)}`;
                const proxyFromPage = (pageUrl) => `${OG_FN}?url=${encodeURIComponent(pageUrl)}`;
                
                // Fallback chain to prevent loops
                const primary = article.image_url || extractImageFromContent(article.summary || article.content) || null;
                const pageProxy = proxyFromPage(article.url);
                const imageProxy = primary ? proxyImage(primary) : pageProxy;
                
                let imageUrl = primary || pageProxy;
                console.log(`Article ${article.id}: Primary image = ${primary}, Using proxy = ${imageUrl}`);
            
            // Generate takeaways and why it matters
            const takeaways = generateTakeaways(article.summary || article.content, article.title);
            const whyItMatters = generateWhyItMatters(article.summary || article.content, article.title, theme);
            
            // Format date
            const publishedDate = article.published_at ? new Date(article.published_at).toLocaleDateString() : 'Recent';
            
            // Build takeaways HTML
            const takeawaysHtml = takeaways.length > 0 ? `
                <div class="takeaways">
                    ${takeaways.map(takeaway => `
                        <div class="takeaway-item">
                            <span>${takeaway}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';
            
            // Build fallback image URL
            const fallbackImageUrl = getFallbackImage(article.id);
            
            card.innerHTML = `
                <div class="article-image-container">
                    <img src="${imageUrl}" alt="${article.title}" class="article-image" 
                         referrerPolicy="no-referrer" loading="lazy"
                         onerror="handleImageError(this, '${imageProxy}', '${fallbackImageUrl}')">
                    <div class="source-badge">${article.source}</div>
                </div>
                <div class="article-content">
                    <h3 class="article-title">${article.title}</h3>
                    ${takeawaysHtml}
                    <div class="why-it-matters">
                        <div class="why-it-matters-title">Why it matters</div>
                        <div class="why-it-matters-text">${whyItMatters}</div>
                    </div>
                    <div class="article-footer">
                        <span class="article-date">${publishedDate}</span>
                    </div>
                </div>
            `;
                
                // Add click event listener to open article
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.open(article.url, '_blank', 'noopener,noreferrer');
                });
                
                return card;
            } catch (error) {
                console.error('Error creating article card:', error);
                // Return a simple error card
                const errorCard = document.createElement('div');
                errorCard.className = 'article-card';
                errorCard.innerHTML = `
                    <div class="article-content">
                        <h3 class="article-title">Error loading article</h3>
                        <p>There was an error displaying this article.</p>
                    </div>
                `;
                return errorCard;
            }
        }

        // Show/hide loading state
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // Load top articles for homepage
        async function loadHomeArticles() {
            const container = document.getElementById('home-articles-grid');
            container.innerHTML = '';

            showLoading(true);
            
            try {
                console.log('Loading top 7 articles for homepage');
                const response = await fetch(`${API_BASE}/api/v4/home?limit=7`);
                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    console.log(`Creating ${data.articles.length} homepage article cards`);
                    data.articles.forEach((article, index) => {
                        console.log(`Creating homepage card ${index + 1} for article: ${article.title}`);
                        const articleCard = createArticleCard(article, 'homepage');
                        container.appendChild(articleCard);
                    });
                } else {
                    console.log('No articles found for homepage');
                    container.innerHTML = '<p>No articles found for homepage.</p>';
                }
            } catch (error) {
                console.error('Error loading homepage articles:', error);
                container.innerHTML = '<p>Error loading articles.</p>';
            } finally {
                showLoading(false);
            }
        }

        // Navigation functions
        async function showHome() {
            currentTheme = 'home';
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('theme-page').classList.add('hidden');
            // Remove active class from all nav links when on home
            updateNavigation(null);
            
            // Load top 7 articles for homepage
            await loadHomeArticles();
        }

        async function displayArticles(theme) {
            const container = document.getElementById('articles-container');
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/api/v4/${theme}?limit=10`);
                const data = await response.json();
                
                container.innerHTML = '';
                
                if (data.articles && data.articles.length > 0) {
                    data.articles.forEach(article => {
                        const card = createArticleCard(article, theme);
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="no-articles">No articles found for this category.</p>';
                }
            } catch (error) {
                console.error('Error loading articles:', error);
                container.innerHTML = '<p class="error">Error loading articles. Please try again.</p>';
            } finally {
                showLoading(false);
            }
        }

        async function showTheme(theme, targetElement = null) {
            currentTheme = theme;
            const themeConfig = THEMES[theme];
            
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('theme-page').classList.remove('hidden');
            
            // Update theme page header
            document.getElementById('theme-title').textContent = themeConfig.name;
            document.getElementById('theme-subtitle').textContent = themeConfig.description;
            
            // Update navigation
            updateNavigation(targetElement);
            
            // Display articles
            await displayArticles(theme);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            showHome();
        });
    </script>
</body>
</html><!-- Force refresh Tue Oct  7 09:24:46 EDT 2025 -->
