<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Pulse - Construction & Real Estate Intelligence v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #ffffff;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --popover: #ffffff;
            --popover-foreground: #0f172a;
            --primary: #0f172a;
            --primary-foreground: #f8fafc;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #0f172a;
            --radius: 0.5rem;
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --foreground: #f8fafc;
            --card: #1e293b;
            --card-foreground: #f8fafc;
            --popover: #1e293b;
            --popover-foreground: #f8fafc;
            --primary: #f8fafc;
            --primary-foreground: #0f172a;
            --secondary: #334155;
            --secondary-foreground: #f8fafc;
            --muted: #334155;
            --muted-foreground: #94a3b8;
            --accent: #334155;
            --accent-foreground: #f8fafc;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #334155;
            --input: #334155;
            --ring: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            height: 80px;
        }

        .logo:hover {
            opacity: 0.8;
        }

        .logo-image {
            height: 80px;
            width: auto;
        }

        .nav {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav a {
            text-decoration: none;
            color: var(--muted-foreground);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav a:hover,
        .nav a.active {
            color: var(--foreground);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem;
            cursor: pointer;
            color: var(--foreground);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--accent);
        }

        /* Main Content */
        .main {
            padding: 2rem 0;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--muted-foreground);
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }

        /* Theme Grid */
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .theme-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--ring);
        }

        .theme-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6);
        }

        .theme-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .theme-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .theme-icon.opportunities { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .theme-icon.practices { background: linear-gradient(135deg, #10b981, #059669); }
        .theme-icon.vision { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .theme-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .theme-description {
            color: var(--muted-foreground);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .theme-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .article-count {
            background: var(--secondary);
            color: var(--secondary-foreground);
            padding: 0.25rem 0.75rem;
            border-radius: calc(var(--radius) / 2);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .view-articles {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .view-articles:hover {
            color: var(--ring);
        }

        /* Articles Grid */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Article Card */
        .article-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--ring);
        }

        /* Image Container */
        .article-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            overflow: hidden;
            background: var(--muted);
        }

        .article-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .article-card:hover .article-image {
            transform: scale(1.05);
        }

        /* Source Badge */
        .source-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: calc(var(--radius) / 2);
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* Article Content */
        .article-content {
            padding: 1.5rem;
        }

        .article-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.75rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-synopsis {
            color: var(--muted-foreground);
            margin-bottom: 1rem;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Takeaways */
        .takeaways {
            margin-bottom: 1rem;
        }

        .takeaway-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }

        .takeaway-checkmark {
            color: #10b981;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        /* Why It Matters */
        .why-it-matters {
            background: var(--secondary) !important;
            border-left: 4px solid var(--primary) !important;
            padding: 1rem !important;
            border-radius: 0 var(--radius) var(--radius) 0 !important;
            margin-bottom: 1rem !important;
            display: block !important;
        }

        .why-it-matters-title {
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .why-it-matters-text {
            font-size: 0.875rem;
            color: var(--muted-foreground);
            line-height: 1.5;
        }

        /* Article Footer */
        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .article-date {
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }

        .article-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .article-link:hover {
            color: var(--ring);
            transform: translateX(2px);
        }

        .article-link-icon {
            width: 1rem;
            height: 1rem;
            transition: transform 0.2s;
        }

        .article-link:hover .article-link-icon {
            transform: translateX(2px);
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--muted-foreground);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                gap: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .articles-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .themes-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Hidden class for dynamic content */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo" onclick="showHome()">
                    <img src="data:image/png;base64,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" alt="BUILT BY MARK SCOTT" class="logo-image">
                </a>
                <nav class="nav">
                    <a href="#" class="nav-link" onclick="showTheme('opportunities')">Opportunities</a>
                    <a href="#" class="nav-link" onclick="showTheme('practices')">Practices</a>
                    <a href="#" class="nav-link" onclick="showTheme('vision')">Vision</a>
                </nav>
                <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
            </div>
        </div>
    </header>

    <main class="main">
    <div class="container">
        <!-- Home Page -->
        <div id="home-page">
                <h1 class="page-title">Construction & Real Estate Intelligence</h1>
                <p class="page-subtitle">Discover insights, opportunities, and innovations shaping the built environment</p>
                
                <div id="themes-grid" class="themes-grid">
                    <!-- Theme cards will be populated by JavaScript -->
            </div>
        </div>

        <!-- Theme Pages -->
        <div id="theme-page" class="hidden">
                <div id="theme-header">
                    <h1 id="theme-title" class="page-title"></h1>
                    <p id="theme-subtitle" class="page-subtitle"></p>
                        </div>
                
                <div id="articles-grid" class="articles-grid">
                    <!-- Articles will be populated by JavaScript -->
                    </div>
                </div>

            <!-- Loading State -->
            <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                Loading articles...
                </div>
                </div>
    </main>

    <script>
        const API_BASE = 'https://newsletter-api-v2.onrender.com';
        
        const THEMES = {
            opportunities: {
                name: 'Creative Opportunities',
                description: 'Entrepreneurial success stories, wealth creation, and innovative deal structures',
                icon: 'ðŸ’°',
                color: '#3b82f6'
            },
            practices: {
                name: 'Building Practices',
                description: 'Construction methods, productivity insights, and efficiency improvements',
                icon: 'ðŸ”§',
                color: '#10b981'
            },
            vision: {
                name: 'Smart Cities & Vision',
                description: 'Future-focused insights on urban development and smart city technologies',
                icon: 'ðŸ”®',
                color: '#8b5cf6'
            }
        };

        let currentTheme = 'home';

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            body.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
        }

        // Navigation
        function updateNavigation(activeLink) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Enhanced image extraction utility
        function extractImageFromContent(content) {
            if (!content) return null;
            
            // Create a temporary DOM element to parse HTML properly
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Try to find img tags with better parsing
            const images = tempDiv.querySelectorAll('img');
            
            for (let img of images) {
                let imageUrl = img.src || img.getAttribute('src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
                
                // Try data-src (lazy loading)
                imageUrl = img.getAttribute('data-src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
                
                // Try data-lazy-src
                imageUrl = img.getAttribute('data-lazy-src');
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
            }
            
            // Also try regex extraction as fallback for malformed HTML
            const imgRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
            let imgMatch = imgRegex.exec(content);
            if (imgMatch) {
                let imageUrl = imgMatch[1];
                if (imageUrl && isValidImageUrl(imageUrl)) {
                    const cleanUrl = cleanImageUrl(imageUrl);
                    if (cleanUrl) return cleanUrl;
                }
            }
            
            // Try to find srcset
            const srcsetImgs = tempDiv.querySelectorAll('img[srcset]');
            for (let img of srcsetImgs) {
                const srcset = img.getAttribute('srcset');
                if (srcset) {
                    const urls = srcset.split(',').map(src => src.trim().split(' ')[0]);
                    for (const url of urls) {
                        if (isValidImageUrl(url)) {
                            const cleanUrl = cleanImageUrl(url);
                            if (cleanUrl) return cleanUrl;
                        }
                    }
                }
            }
            
            // Try to find Open Graph meta tags in content
            const ogImageRegex = /<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/gi;
            let ogMatch = ogImageRegex.exec(content);
            if (ogMatch) {
                const imageUrl = ogMatch[1];
                if (isValidImageUrl(imageUrl)) {
                    return cleanImageUrl(imageUrl);
                }
            }
            
            // Try to find Twitter card meta tags
            const twitterImageRegex = /<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["']/gi;
            let twitterMatch = twitterImageRegex.exec(content);
            if (twitterMatch) {
                const imageUrl = twitterMatch[1];
                if (isValidImageUrl(imageUrl)) {
                    return cleanImageUrl(imageUrl);
                }
            }
            
            return null;
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            
            // Must be a valid image extension
            const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)$/i;
            if (!imageExtensions.test(url)) return false;
            
            // Exclude common non-content images
            const excludePatterns = /logo|icon|avatar|placeholder|spacer|pixel|banner|advert|ad|social|share|button|nav|header|footer|widget/i;
            if (excludePatterns.test(url)) return false;
            
            // Exclude very small images (likely icons)
            if (url.includes('16x16') || url.includes('32x32') || url.includes('24x24')) return false;
            
            // Must be a proper URL
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        function cleanImageUrl(url) {
            if (url.startsWith('//')) {
                return 'https:' + url;
            }
            if (url.startsWith('/')) {
                return window.location.origin + url;
            }
            return url;
        }

        function getFallbackImage(articleId, theme = 'general') {
            const themeImages = {
                opportunities: [
                    'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Business building
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // City skyline
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Construction
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Architecture
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Real estate
                ],
                practices: [
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Construction site
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Building construction
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Modern building
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Architecture
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Urban development
                ],
                vision: [
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Smart city
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Future buildings
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Sustainable design
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80', // Innovation
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80'  // Technology
                ],
                general: [
                    'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                    'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'
                ]
            };
            
            const images = themeImages[theme] || themeImages.general;
            return images[articleId % images.length];
        }

        // Robust image error handling with proxy fallback
        function handleImageError(imgElement, proxyUrl, fallbackUrl) {
            if (!imgElement.dataset.triedProxy) {
                // Try proxy first
                imgElement.dataset.triedProxy = 'true';
                imgElement.src = proxyUrl;
                console.log('Image failed, trying proxy:', proxyUrl);
            } else if (!imgElement.dataset.triedFallback) {
                // Try fallback
                imgElement.dataset.triedFallback = 'true';
                imgElement.src = fallbackUrl;
                console.log('Proxy failed, using fallback:', fallbackUrl);
            } else {
                // All options exhausted
                console.log('All image options failed for:', imgElement.alt);
            }
        }

        // Generate takeaways from article content
        function generateTakeaways(content, title) {
            const takeaways = [];
            const text = content ? content.replace(/<[^>]*>/g, '') : '';
            
            // Simple keyword-based takeaways
            if (text.toLowerCase().includes('roi') || text.toLowerCase().includes('return on investment')) {
                takeaways.push('Strong ROI potential identified');
            }
            if (text.toLowerCase().includes('innovation') || text.toLowerCase().includes('breakthrough')) {
                takeaways.push('Innovation and breakthrough technology');
            }
            if (text.toLowerCase().includes('growth') || text.toLowerCase().includes('expansion')) {
                takeaways.push('Growth and expansion opportunities');
            }
            if (text.toLowerCase().includes('efficiency') || text.toLowerCase().includes('productivity')) {
                takeaways.push('Efficiency and productivity improvements');
            }
            if (text.toLowerCase().includes('sustainable') || text.toLowerCase().includes('green')) {
                takeaways.push('Sustainable and environmentally friendly');
            }
            
            return takeaways.slice(0, 3); // Limit to 3 takeaways
        }

        // Generate "why it matters" text
        function generateWhyItMatters(content, title, theme) {
            const text = content ? content.replace(/<[^>]*>/g, '') : '';
            const lowerText = text.toLowerCase();
            const lowerTitle = title.toLowerCase();

            if (theme === 'opportunities') {
                if (lowerText.includes('investment') || lowerText.includes('roi')) {
                    return 'This represents a significant investment opportunity with potential for strong returns in the evolving real estate market.';
                }
                if (lowerText.includes('development') || lowerText.includes('construction')) {
                    return 'Highlights emerging development opportunities that could reshape local markets and create value for investors.';
                }
                return 'Identifies key market opportunities that forward-thinking investors should consider for portfolio diversification.';
            }
            
            if (theme === 'practices') {
                if (lowerText.includes('efficiency') || lowerText.includes('productivity')) {
                    return 'Demonstrates proven methods for improving construction efficiency and reducing project costs.';
                }
                if (lowerText.includes('technology') || lowerText.includes('innovation')) {
                    return 'Showcases cutting-edge practices that are transforming how we build and manage real estate.';
                }
                return 'Provides actionable insights for improving construction practices and operational efficiency.';
            }
            
            if (theme === 'vision') {
                if (lowerText.includes('smart city') || lowerText.includes('technology')) {
                    return 'Offers a glimpse into the future of urban development and smart city infrastructure.';
                }
                if (lowerText.includes('sustainable') || lowerText.includes('green')) {
                    return 'Represents the future direction of sustainable urban development and environmental responsibility.';
                }
                return 'Provides valuable insights into emerging trends that will shape the future of real estate and urban planning.';
            }
            
            return 'This insight provides valuable perspective on current trends and future opportunities in the built environment.';
        }

        // Display theme cards on home page
        async function displayThemes() {
            const container = document.getElementById('themes-grid');
            container.innerHTML = '';

            for (const [themeKey, theme] of Object.entries(THEMES)) {
                const themeCard = document.createElement('div');
                themeCard.className = 'theme-card';
                themeCard.onclick = () => showTheme(themeKey);
                
                // Show loading state initially
                themeCard.innerHTML = `
                    <div class="theme-header">
                        <div class="theme-icon ${themeKey}">
                            ${theme.icon}
                        </div>
                        <h3 class="theme-title">${theme.name}</h3>
                    </div>
                    <p class="theme-description">${theme.description}</p>
                    <div class="theme-stats">
                        <span class="article-count">Loading...</span>
                        <a class="view-articles" onclick="event.stopPropagation(); showTheme('${themeKey}')">
                            View Articles
                        </a>
                    </div>
                `;
                
                container.appendChild(themeCard);
                
                // Fetch actual article count
                try {
                    const response = await fetch(`${API_BASE}/api/v4/${themeKey}?limit=50`);
                    const data = await response.json();
                    const articleCount = data.articles ? data.articles.length : 0;
                    
                    const countElement = themeCard.querySelector('.article-count');
                    countElement.textContent = `${articleCount} articles`;
                } catch (error) {
                    console.error(`Error fetching ${themeKey} count:`, error);
                    const countElement = themeCard.querySelector('.article-count');
                    countElement.textContent = '0 articles';
                }
            }
        }

        // Display articles for a theme
        async function displayArticles(theme) {
            const container = document.getElementById('articles-grid');
            container.innerHTML = '';

            showLoading(true);
            
            try {
                console.log(`Fetching articles for theme: ${theme}`);
                const response = await fetch(`${API_BASE}/api/v4/${theme}?limit=20`);
                console.log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`Received data:`, data);
                
                if (data.articles && data.articles.length > 0) {
                    console.log(`Creating ${data.articles.length} article cards`);
                    data.articles.forEach((article, index) => {
                        console.log(`Creating card ${index + 1} for article: ${article.title}`);
                        const articleCard = createArticleCard(article, theme);
                        container.appendChild(articleCard);
                    });
                } else {
                    console.log('No articles found in response');
                    container.innerHTML = '<p>No articles found for this theme.</p>';
                }
            } catch (error) {
                console.error('Error fetching articles:', error);
                container.innerHTML = `<p>Error loading articles: ${error.message}. Please try again later.</p>`;
            } finally {
                showLoading(false);
            }
        }

        // Create article card
        function createArticleCard(article, theme) {
            try {
                console.log(`Creating article card for: ${article.title}`);
                const card = document.createElement('div');
                card.className = 'article-card';
                
                // Enhanced image extraction with proxy system
                const OG_FN = `${API_BASE}/api/v4/proxy/image`;
                const proxyImage = (url) => `${OG_FN}?image=${encodeURIComponent(url)}`;
                const proxyFromPage = (pageUrl) => `${OG_FN}?url=${encodeURIComponent(pageUrl)}`;
                
                // Fallback chain to prevent loops
                const primary = article.image_url || extractImageFromContent(article.summary || article.content) || null;
                const pageProxy = proxyFromPage(article.url);
                const imageProxy = primary ? proxyImage(primary) : pageProxy;
                
                let imageUrl = primary || pageProxy;
                console.log(`Article ${article.id}: Primary image = ${primary}, Using proxy = ${imageUrl}`);
            
            // Generate takeaways and why it matters
            const takeaways = generateTakeaways(article.summary || article.content, article.title);
            const whyItMatters = generateWhyItMatters(article.summary || article.content, article.title, theme);
            
            // Format date
            const publishedDate = article.published_at ? new Date(article.published_at).toLocaleDateString() : 'Recent';
            
            card.innerHTML = `
                    <div class="article-image-container">
                    <img src="${imageUrl}" alt="${article.title}" class="article-image" 
                         referrerPolicy="no-referrer" loading="lazy"
                         onerror="handleImageError(this, '${imageProxy}', '${getFallbackImage(article.id)}')">
                        <div class="source-badge">${article.source}</div>
                    </div>
                    <div class="article-content">
                    <h3 class="article-title">${article.title}</h3>
                    <p class="article-synopsis">${article.summary ? article.summary.replace(/<[^>]*>/g, '').substring(0, 200) + '...' : 'No summary available'}</p>
                    
                        ${takeaways.length > 0 ? `
                        <div class="takeaways">
                                ${takeaways.map(takeaway => `
                                    <div class="takeaway-item">
                                    <span class="takeaway-checkmark">âœ“</span>
                                    <span>${takeaway}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    
                            <div class="why-it-matters">
                        <div class="why-it-matters-title">Why it matters</div>
                        <div class="why-it-matters-text">${whyItMatters}</div>
                            </div>
                    
                    <div class="article-footer">
                        <span class="article-date">${publishedDate}</span>
                        <a href="${article.url}" target="_blank" rel="noopener" class="article-link">
                            Read more
                            <svg class="article-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </a>
                    </div>
                    </div>
                `;
                
                return card;
            } catch (error) {
                console.error('Error creating article card:', error);
                // Return a simple error card
                const errorCard = document.createElement('div');
                errorCard.className = 'article-card';
                errorCard.innerHTML = `
                    <div class="article-content">
                        <h3 class="article-title">Error loading article</h3>
                        <p class="article-synopsis">There was an error displaying this article.</p>
                    </div>
                `;
                return errorCard;
            }
        }

        // Show/hide loading state
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // Navigation functions
        function showHome() {
            currentTheme = 'home';
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('theme-page').classList.add('hidden');
            // Remove active class from all nav links when on home
            updateNavigation(null);
            displayThemes();
        }

        async function showTheme(theme, targetElement = null) {
            currentTheme = theme;
            const themeConfig = THEMES[theme];
            
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('theme-page').classList.remove('hidden');
            
            // Update theme page header
            document.getElementById('theme-title').textContent = themeConfig.name;
            document.getElementById('theme-subtitle').textContent = themeConfig.description;
            
            // Update navigation
            updateNavigation(targetElement);
            
            // Display articles
            await displayArticles(theme);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            showHome();
        });
    </script>
</body>
</html>