<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Pulse - Construction & Real Estate Intelligence v2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8fafc;
        }

        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            opacity: 0.8;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
            text-align: center;
            margin-bottom: 3rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 2rem;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .hero-stat-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Featured Video */
        .featured-video {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .featured-video.show {
            display: block;
        }

        .video-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .video-icon {
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .video-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            align-items: start;
        }

        .video-thumbnail {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .play-button:hover {
            background: white;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-info h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .video-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #718096;
        }

        .video-summary {
            color: #4a5568;
            line-height: 1.6;
        }

        /* Theme Sections */
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .theme-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .theme-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .theme-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .theme-icon.opportunities { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .theme-icon.practices { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .theme-icon.vision { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

        .theme-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .theme-description {
            color: #718096;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .theme-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .article-count {
            font-weight: 600;
            color: #4a5568;
        }

        .view-articles {
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .view-articles:hover {
            background: #5a67d8;
        }

        /* Articles List */
        .articles-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .back-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .articles-grid {
            display: grid;
            gap: 1.5rem;
        }

        .article-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            margin-bottom: 2rem;
        }

        .article-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        .article-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #f3f4f6;
            overflow: hidden;
        }

        .article-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .article-card:hover .article-image {
            transform: scale(1.05);
        }

        .article-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
        }

        .article-image-placeholder svg {
            width: 80px;
            height: 80px;
            color: #9ca3af;
            opacity: 0.5;
        }

        .source-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #111827;
            border: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }

        .article-content {
            padding: 1.5rem;
        }

        .article-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            line-height: 1.3;
            margin-bottom: 0.75rem;
            transition: color 0.2s ease;
        }

        .article-card:hover .article-title {
            color: #3b82f6;
        }

        .article-synopsis {
            color: rgba(17, 24, 39, 0.9);
            margin-bottom: 1rem;
            line-height: 1.6;
            font-size: 0.9375rem;
        }

        .article-takeaways {
            margin-bottom: 1rem;
        }

        .takeaway-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .takeaway-checkmark {
            font-size: 1.125rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .takeaway-text {
            font-size: 0.875rem;
            color: rgba(17, 24, 39, 0.8);
            line-height: 1.5;
        }

        .why-it-matters {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(243, 244, 246, 0.5);
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }

        .why-it-matters-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .why-it-matters-text {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
        }

        .article-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .article-meta span {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .article-meta i {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .article-summary {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 1.25rem;
            font-size: 0.875rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #f3f4f6;
        }

        .article-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #3b82f6;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .article-link:hover {
            gap: 0.75rem;
        }

        .article-link-icon {
            width: 1rem;
            height: 1rem;
            transition: transform 0.2s ease;
        }

        .article-link:hover .article-link-icon {
            transform: translate(0.125rem, -0.125rem);
        }

        .article-date {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        /* Top Stories Section */
        .top-stories-section {
            margin-bottom: 2rem;
        }

        .top-stories-grid {
            display: grid;
            gap: 1rem;
        }

        .top-story {
            border-left: 3px solid #f59e0b;
        }

        .section-header {
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: #f59e0b;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 4rem;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error State */
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 2rem 0;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .hero-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .themes-grid {
                grid-template-columns: 1fr;
            }

            .video-content {
                grid-template-columns: 1fr;
            }

            .article-header {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Hidden class for navigation */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-building"></i>
                Urban Pulse
            </div>
            <ul class="nav-links">
                <li><a onclick="showHome()">Home</a></li>
                <li><a onclick="showTheme('opportunities')">Opportunities</a></li>
                <li><a onclick="showTheme('practices')">Practices</a></li>
                <li><a onclick="showTheme('vision')">Vision</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Home Page -->
        <div id="home-page">
            <div class="hero">
                <div class="hero-content">
                    <h1>Urban Pulse</h1>
                    <p>Your intelligence hub for construction innovation, market opportunities, and real estate development insights</p>
                    
                    <div class="hero-stats">
                        <div class="hero-stat">
                            <div class="hero-stat-value" id="total-articles">-</div>
                            <div class="hero-stat-label">Articles</div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value" id="avg-score">-</div>
                            <div class="hero-stat-label">Avg Score</div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value" id="recent-articles">-</div>
                            <div class="hero-stat-label">Today</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Featured Video -->
            <div id="featured-video" class="featured-video">
                <div class="video-header">
                    <div class="video-icon">
                        <i class="fas fa-play"></i>
                    </div>
                    <h2>Featured Video</h2>
                </div>
                <div class="video-content">
                    <div class="video-thumbnail">
                        <img id="video-thumbnail" src="" alt="Video thumbnail">
                        <div class="play-button" onclick="openVideo()">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="video-info">
                        <h3 id="video-title">Video Title</h3>
                        <div class="video-meta">
                            <span id="video-channel">Channel</span>
                            <span id="video-views">Views</span>
                            <span id="video-duration">Duration</span>
                        </div>
                        <div class="video-summary" id="video-summary">
                            Video summary will appear here...
                        </div>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading latest insights...</p>
            </div>

            <div id="error" class="error hidden">
                <p>Unable to load content. Please try again later.</p>
            </div>

            <div id="themes-container" class="hidden">
                <div class="themes-grid" id="themes-grid">
                    <!-- Themes will be populated here -->
                </div>
            </div>
        </div>

        <!-- Theme Pages -->
        <div id="theme-page" class="hidden">
            <div class="articles-section">
                <div class="section-header">
                    <div>
                        <div class="back-link" onclick="showHome()">
                            <i class="fas fa-arrow-left"></i>
                            Back to Home
                        </div>
                        <h2 class="section-title" id="theme-title">Theme Articles</h2>
                    </div>
                </div>

                <div id="theme-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading articles...</p>
                </div>

                <div id="theme-error" class="error hidden">
                    <p>Unable to load articles for this theme.</p>
                </div>

                <div id="articles-grid" class="articles-grid hidden">
                    <!-- Articles will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin;
        
        // Theme configuration
        const THEMES = {
            opportunities: {
                name: 'Opportunities',
                description: 'Market growth, investments, and emerging trends in construction and real estate',
                icon: 'fas fa-chart-line',
                color: 'opportunities'
            },
            practices: {
                name: 'Practices',
                description: 'Best practices, technology, and methodologies for building and construction',
                icon: 'fas fa-tools',
                color: 'practices'
            },
            vision: {
                name: 'Vision',
                description: 'Smart cities, future-of-living models, and transformative industry trends',
                icon: 'fas fa-eye',
                color: 'vision'
            }
        };

        // Current page state
        let currentPage = 'home';
        let currentTheme = null;
        let featuredVideo = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadHomePage();
        });

        // Navigation functions
        function showHome() {
            currentPage = 'home';
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('theme-page').classList.add('hidden');
            loadHomePage();
        }

        function showTheme(themeName) {
            currentPage = 'theme';
            currentTheme = themeName;
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('theme-page').classList.remove('hidden');
            loadThemePage(themeName);
        }

        // Load home page
        async function loadHomePage() {
            showLoading('loading');
            hideError('error');
            hideContent('themes-container');

            try {
                // Load homepage data
                const homeResponse = await fetch(`${API_BASE}/api/v4/home?limit=20&hours=24`);
                const homeData = await homeResponse.json();
                
                // Load today's top stories
                const topStoriesResponse = await fetch(`${API_BASE}/api/v4/home?limit=5&hours=24`);
                const topStoriesData = await topStoriesResponse.json();

                // Load admin stats for hero section
                const statsResponse = await fetch(`${API_BASE}/api/v4/admin/stats`);
                const stats = await statsResponse.json();

                // Update hero stats
                document.getElementById('total-articles').textContent = stats.total_articles || 0;
                document.getElementById('recent-articles').textContent = stats.recent_articles_24h || 0;
                document.getElementById('avg-score').textContent = '7.2'; // Placeholder

                // Load featured video
                if (homeData.featured_video) {
                    featuredVideo = homeData.featured_video;
                    displayFeaturedVideo(featuredVideo);
                }

                // Group articles by themes
                const themes = Object.keys(THEMES).map(themeName => {
                    const config = THEMES[themeName];
                    let themeArticles = [];
                    
                    // Filter articles by theme scores
                    if (homeData.articles) {
                        themeArticles = homeData.articles.filter(article => {
                            const score = article.score[themeName] || 0;
                            return score > 0;
                        });
                    }
                    
                    return {
                        name: themeName,
                        data: { articles: themeArticles },
                        config: config
                    };
                });

                // Display today's top stories first
                if (topStoriesData.articles && topStoriesData.articles.length > 0) {
                    displayTopStories(topStoriesData.articles);
                }
                
                displayThemes(themes);
                hideLoading('loading');
                showContent('themes-container');
            } catch (error) {
                console.error('Error loading themes:', error);
                hideLoading('loading');
                showError('error');
            }
        }

        // Load theme page
        async function loadThemePage(themeName) {
            const themeConfig = THEMES[themeName];
            
            // Update page title
            document.getElementById('theme-title').textContent = themeConfig.name;
            
            showLoading('theme-loading');
            hideError('theme-error');
            hideContent('articles-grid');

            try {
                // Load articles for specific theme
                const articlesResponse = await fetch(`${API_BASE}/api/v4/${themeName}?limit=50`);
                const articlesData = await articlesResponse.json();

                if (articlesData.articles && articlesData.articles.length > 0) {
                    displayArticles(articlesData.articles, themeName);
                    hideLoading('theme-loading');
                    showContent('articles-grid');
                } else {
                    hideLoading('theme-loading');
                    showError('theme-error');
                }
            } catch (error) {
                console.error('Error loading theme:', error);
                hideLoading('theme-loading');
                showError('theme-error');
            }
        }

        // Display featured video
        function displayFeaturedVideo(video) {
            const videoContainer = document.getElementById('featured-video');
            const thumbnail = document.getElementById('video-thumbnail');
            const title = document.getElementById('video-title');
            const channel = document.getElementById('video-channel');
            const views = document.getElementById('video-views');
            const duration = document.getElementById('video-duration');
            const summary = document.getElementById('video-summary');

            if (video.thumbnail_url) {
                thumbnail.src = video.thumbnail_url;
            }

            title.textContent = video.title || 'Featured Video';
            channel.textContent = video.channel_name || 'Unknown Channel';
            views.textContent = video.view_count ? `${video.view_count.toLocaleString()} views` : 'Views unknown';
            duration.textContent = video.duration ? formatDuration(video.duration) : 'Duration unknown';
            summary.textContent = video.summary || 'No summary available.';

            videoContainer.classList.add('show');
        }

        // Format video duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Open video in new tab
        function openVideo() {
            if (featuredVideo && featuredVideo.url) {
                window.open(featuredVideo.url, '_blank');
            }
        }

        // Display themes on home page
        function displayThemes(themes) {
            const container = document.getElementById('themes-grid');
            container.innerHTML = '';

            themes.forEach(theme => {
                const themeCard = document.createElement('div');
                themeCard.className = 'theme-card';
                
                const articleCount = theme.data.articles ? theme.data.articles.length : 0;
                
                themeCard.innerHTML = `
                    <div class="theme-header">
                        <div class="theme-icon ${theme.name}">
                            <i class="${theme.config.icon}"></i>
                        </div>
                        <h3 class="theme-title">${theme.config.name}</h3>
                    </div>
                    <p class="theme-description">${theme.config.description}</p>
                    <div class="theme-stats">
                        <span class="article-count">${articleCount} articles</span>
                        <a class="view-articles" onclick="showTheme('${theme.name}')">
                            View Articles
                        </a>
                    </div>
                `;
                
                container.appendChild(themeCard);
            });
        }

        // Display today's top stories
        function displayTopStories(articles) {
            const container = document.getElementById('themes-container');
            
            // Create top stories section
            const topStoriesSection = document.createElement('div');
            topStoriesSection.className = 'top-stories-section';
            topStoriesSection.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-fire"></i>
                        Today's Top Stories
                    </h2>
                </div>
                <div class="top-stories-grid" id="top-stories-grid">
                    <!-- Top stories will be populated here -->
                </div>
            `;
            
            // Insert at the beginning of the container
            container.insertBefore(topStoriesSection, container.firstChild);
            
            // Display the top stories
            const topStoriesGrid = document.getElementById('top-stories-grid');
            topStoriesGrid.innerHTML = '';
            
            articles.slice(0, 5).forEach(article => {
                const articleCard = document.createElement('div');
                articleCard.className = 'article-card top-story';
                
                const publishedDate = article.published_at ? 
                    new Date(article.published_at).toLocaleDateString() : 'Today';
                
                // Generate image URL (try to extract from content first)
                let imageUrl = article.thumbnail_url;
                
                if (!imageUrl && article.content) {
                    console.log('Extracting image from content for:', article.title);
                    console.log('Article content length:', article.content.length);
                    console.log('Content preview:', article.content.substring(0, 500));
                    
                    imageUrl = extractImageFromContent(article.content);
                    console.log('Raw extracted image URL:', imageUrl);
                    
                    if (imageUrl) {
                        imageUrl = cleanImageUrl(imageUrl, article.url);
                        console.log('Cleaned image URL:', imageUrl);
                    } else {
                        console.log('No image found in content, trying summary...');
                        if (article.summary) {
                            imageUrl = extractImageFromContent(article.summary);
                            if (imageUrl) {
                                imageUrl = cleanImageUrl(imageUrl, article.url);
                                console.log('Found image in summary:', imageUrl);
                            }
                        }
                    }
                }
                
                // If still no image, use a unique fallback based on article ID
                if (!imageUrl) {
                    const fallbackImages = [
                        'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'
                    ];
                    const imageIndex = (article.id || 0) % fallbackImages.length;
                    imageUrl = fallbackImages[imageIndex];
                    console.log('Using unique fallback image for:', article.title, 'Index:', imageIndex);
                }
                
                // Generate takeaways from summary (simple bullet points)
                const takeaways = generateTakeaways(article.summary || article.content);
                
                articleCard.innerHTML = `
                    <div class="article-image-container">
                        <img src="${imageUrl}" alt="${article.title}" class="article-image" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\"article-image-placeholder\\"><svg fill=\\"none\\" stroke=\\"currentColor\\" viewBox=\\"0 0 24 24\\"><path stroke-linecap=\\"round\\" stroke-linejoin=\\"round\\" stroke-width=\\"1.5\\" d=\\"M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z\\" /></svg></div>'">
                        <div class="source-badge">${article.source}</div>
                    </div>
                    <div class="article-content">
                        <h2 class="article-title">${article.title}</h2>
                        <p class="article-synopsis">${article.summary || 'No summary available.'}</p>
                        ${takeaways.length > 0 ? `
                            <div class="article-takeaways">
                                ${takeaways.map(takeaway => `
                                    <div class="takeaway-item">
                                        <span class="takeaway-checkmark">✅</span>
                                        <p class="takeaway-text">${takeaway}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="article-link">
                            <span>Read full story</span>
                            <svg class="article-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                    </div>
                `;
                
                topStoriesGrid.appendChild(articleCard);
            });
        }

        // Display articles
        function displayArticles(articles, themeName) {
            const container = document.getElementById('articles-grid');
            container.innerHTML = '';

            if (articles.length === 0) {
                container.innerHTML = '<div class="error">No articles available for this theme.</div>';
                return;
            }

            articles.forEach(article => {
                const articleCard = document.createElement('div');
                articleCard.className = `article-card ${themeName}`;
                
                const publishedDate = article.published_at ? 
                    new Date(article.published_at).toLocaleDateString() : 'Unknown date';
                
                const totalScore = article.score.total || 0;
                
                // Generate image URL (try to extract from content first)
                let imageUrl = article.thumbnail_url;
                
                if (!imageUrl && article.content) {
                    console.log('Extracting image from content for:', article.title);
                    console.log('Article content length:', article.content.length);
                    console.log('Content preview:', article.content.substring(0, 500));
                    
                    imageUrl = extractImageFromContent(article.content);
                    console.log('Raw extracted image URL:', imageUrl);
                    
                    if (imageUrl) {
                        imageUrl = cleanImageUrl(imageUrl, article.url);
                        console.log('Cleaned image URL:', imageUrl);
                    } else {
                        console.log('No image found in content, trying summary...');
                        if (article.summary) {
                            imageUrl = extractImageFromContent(article.summary);
                            if (imageUrl) {
                                imageUrl = cleanImageUrl(imageUrl, article.url);
                                console.log('Found image in summary:', imageUrl);
                            }
                        }
                    }
                }
                
                // If still no image, use a unique fallback based on article ID
                if (!imageUrl) {
                    const fallbackImages = [
                        'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&h=600&fit=crop&crop=center&auto=format&q=80',
                        'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800&h=600&fit=crop&crop=center&auto=format&q=80'
                    ];
                    const imageIndex = (article.id || 0) % fallbackImages.length;
                    imageUrl = fallbackImages[imageIndex];
                    console.log('Using unique fallback image for:', article.title, 'Index:', imageIndex);
                }
                
                // Generate takeaways from summary (simple bullet points)
                const takeaways = generateTakeaways(article.summary || article.content);
                
                // Generate "why it matters" from content
                const whyItMatters = generateWhyItMatters(article.summary || article.content);
                
                articleCard.innerHTML = `
                    <div class="article-image-container">
                        <img src="${imageUrl}" alt="${article.title}" class="article-image" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\"article-image-placeholder\\"><svg fill=\\"none\\" stroke=\\"currentColor\\" viewBox=\\"0 0 24 24\\"><path stroke-linecap=\\"round\\" stroke-linejoin=\\"round\\" stroke-width=\\"1.5\\" d=\\"M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z\\" /></svg></div>'">
                        <div class="source-badge">${article.source}</div>
                    </div>
                    <div class="article-content">
                        <h2 class="article-title">${article.title}</h2>
                        <p class="article-synopsis">${article.summary || 'No summary available.'}</p>
                        ${takeaways.length > 0 ? `
                            <div class="article-takeaways">
                                ${takeaways.map(takeaway => `
                                    <div class="takeaway-item">
                                        <span class="takeaway-checkmark">✅</span>
                                        <p class="takeaway-text">${takeaway}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${whyItMatters ? `
                            <div class="why-it-matters">
                                <p class="why-it-matters-title">Why it matters</p>
                                <p class="why-it-matters-text">${whyItMatters}</p>
                            </div>
                        ` : ''}
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="article-link">
                            <span>Read full story</span>
                            <svg class="article-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                    </div>
                `;
                
                container.appendChild(articleCard);
            });
        }

        // Helper functions for article formatting
        async function extractImageFromArticle(articleUrl, articleContent) {
            // First try to get image from article content if available
            if (articleContent) {
                const contentImage = extractImageFromContent(articleContent);
                if (contentImage) {
                    return cleanImageUrl(contentImage, articleUrl);
                }
            }
            
            // Use a reliable link preview service
            try {
                // Use linkpreview.net which is more reliable
                const previewUrl = `https://api.linkpreview.net/?key=5b54e&q=${encodeURIComponent(articleUrl)}`;
                const response = await fetch(previewUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.image && data.image !== '') {
                        return data.image;
                    }
                }
            } catch (error) {
                console.log('Link preview service failed:', error);
            }
            
            // Fallback: Use a simple image proxy service
            try {
                // Try a different approach - use a screenshot service
                const screenshotUrl = `https://api.screenshotmachine.com?key=demo&url=${encodeURIComponent(articleUrl)}&dimension=800x600&format=png&cacheLimit=0`;
                return screenshotUrl;
            } catch (error) {
                console.log('Screenshot service failed:', error);
            }
            
            return null;
        }

        function extractImageFromContent(content) {
            if (!content) return null;
            
            console.log('Extracting images from content, length:', content.length);
            
            // Clean up the content first
            const cleanContent = content.replace(/\\"/g, '"').replace(/\\'/g, "'");
            
            // Try multiple image extraction patterns
            const patterns = [
                // Standard img tags
                /<img[^>]+src="([^"]+)"/gi,
                /<img[^>]+src='([^']+)'/gi,
                // Figure tags with images
                /<figure[^>]*>.*?<img[^>]+src="([^"]+)"/gis,
                /<figure[^>]*>.*?<img[^>]+src='([^']+)'/gis,
                // Any src attribute with image extensions
                /src="([^"]*\.(?:jpg|jpeg|png|gif|webp|svg)[^"]*)"/gi,
                /src='([^']*\.(?:jpg|jpeg|png|gif|webp|svg)[^']*)'/gi,
                // More aggressive patterns
                /https?:\/\/[^"\s]+\.(?:jpg|jpeg|png|gif|webp|svg)/gi,
                /\/[^"\s]*\.(?:jpg|jpeg|png|gif|webp|svg)/gi
            ];
            
            const foundImages = [];
            
            for (const pattern of patterns) {
                const matches = cleanContent.match(pattern);
                if (matches && matches.length > 0) {
                    console.log('Found matches with pattern:', pattern.toString(), matches.length);
                    
                    for (const match of matches) {
                        let imageUrl = match;
                        
                        // Extract URL from img tags
                        if (match.includes('src=')) {
                            const urlMatch = match.match(/src=["']([^"']+)["']/i);
                            if (urlMatch && urlMatch[1]) {
                                imageUrl = urlMatch[1];
                            }
                        }
                        
                        // Clean up the URL
                        imageUrl = imageUrl.replace(/\\/g, '').trim();
                        
                        // Filter out common non-image URLs and check for valid image
                        if (imageUrl.length > 10 &&
                            !imageUrl.includes('logo') && 
                            !imageUrl.includes('icon') && 
                            !imageUrl.includes('avatar') &&
                            !imageUrl.includes('placeholder') &&
                            !imageUrl.includes('spacer') &&
                            !imageUrl.includes('pixel') &&
                            !imageUrl.includes('banner') &&
                            !imageUrl.includes('advertisement') &&
                            !imageUrl.includes('ads') &&
                            !imageUrl.includes('favicon') &&
                            (imageUrl.includes('.jpg') || imageUrl.includes('.jpeg') || 
                             imageUrl.includes('.png') || imageUrl.includes('.gif') || 
                             imageUrl.includes('.webp') || imageUrl.includes('.svg') ||
                             imageUrl.includes('images.') || imageUrl.includes('img.'))) {
                            
                            console.log('Valid image found:', imageUrl);
                            foundImages.push(imageUrl);
                        }
                    }
                }
            }
            
            // Return the first valid image found
            if (foundImages.length > 0) {
                console.log('Returning first valid image:', foundImages[0]);
                return foundImages[0];
            }
            
            console.log('No valid images found in content');
            return null;
        }

        function cleanImageUrl(imageUrl, baseUrl) {
            if (!imageUrl) return null;
            
            // Handle relative URLs
            if (imageUrl.startsWith('//')) {
                return 'https:' + imageUrl;
            } else if (imageUrl.startsWith('/')) {
                try {
                    const base = new URL(baseUrl);
                    return base.origin + imageUrl;
                } catch (e) {
                    return imageUrl;
                }
            } else if (!imageUrl.startsWith('http')) {
                try {
                    const base = new URL(baseUrl);
                    return base.origin + '/' + imageUrl;
                } catch (e) {
                    return imageUrl;
                }
            }
            
            return imageUrl;
        }

        function generateTakeaways(text) {
            if (!text) return [];
            
            // Clean and split text into sentences
            const cleanText = text.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
            const sentences = cleanText.split(/[.!?]+/).filter(s => s.trim().length > 15);
            const takeaways = [];
            
            // Look for sentences with key indicators for insights
            const insightIndicators = [
                'will', 'could', 'should', 'expected', 'projected', 'planned', 'announced', 'reported',
                'increased', 'decreased', 'grew', 'declined', 'rose', 'fell', 'boosted', 'reduced',
                'investment', 'funding', 'revenue', 'profit', 'growth', 'expansion', 'development',
                'new', 'first', 'launch', 'introduce', 'unveil', 'reveal', 'discover', 'breakthrough'
            ];
            
            // Score sentences based on insight indicators
            const scoredSentences = sentences.map(sentence => {
                const lowerSentence = sentence.toLowerCase();
                let score = 0;
                
                insightIndicators.forEach(indicator => {
                    if (lowerSentence.includes(indicator)) {
                        score += 1;
                    }
                });
                
                // Bonus for numbers and percentages
                if (/\d+%|\$\d+|\d+\.\d+/.test(sentence)) {
                    score += 2;
                }
                
                // Bonus for action words
                if (/achieve|create|build|develop|improve|enhance|optimize/.test(lowerSentence)) {
                    score += 1;
                }
                
                return { sentence: sentence.trim(), score };
            });
            
            // Sort by score and take top 3
            scoredSentences.sort((a, b) => b.score - a.score);
            
            for (let i = 0; i < Math.min(scoredSentences.length, 3); i++) {
                const { sentence } = scoredSentences[i];
                if (sentence.length > 15 && sentence.length < 150) {
                    takeaways.push(sentence.substring(0, 100) + (sentence.length > 100 ? '...' : ''));
                }
            }
            
            // Fallback: take first meaningful sentences if no insights found
            if (takeaways.length === 0) {
                for (let i = 0; i < Math.min(sentences.length, 2); i++) {
                    const sentence = sentences[i].trim();
                    if (sentence.length > 20 && sentence.length < 120) {
                        takeaways.push(sentence.substring(0, 80) + (sentence.length > 80 ? '...' : ''));
                    }
                }
            }
            
            return takeaways;
        }

        function generateWhyItMatters(text) {
            if (!text) return null;
            
            // Look for sentences that explain impact or significance
            const impactWords = ['impact', 'significance', 'important', 'crucial', 'key', 'major', 'significant', 'affects', 'influences'];
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 30);
            
            for (const sentence of sentences) {
                const lowerSentence = sentence.toLowerCase();
                if (impactWords.some(word => lowerSentence.includes(word))) {
                    return sentence.trim().substring(0, 200) + (sentence.length > 200 ? '...' : '');
                }
            }
            
            // Fallback: return a middle sentence if it's substantial
            if (sentences.length > 2) {
                const middleSentence = sentences[Math.floor(sentences.length / 2)].trim();
                if (middleSentence.length > 50) {
                    return middleSentence.substring(0, 200) + (middleSentence.length > 200 ? '...' : '');
                }
            }
            
            return null;
        }

        // Utility functions
        function showLoading(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showError(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showContent(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        function hideContent(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }
    </script>
</body>
</html>
